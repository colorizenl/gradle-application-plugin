//-----------------------------------------------------------------------------
// File generated by Colorize Gradle application plugin
//-----------------------------------------------------------------------------

import SwiftUI
import WebKit

@main
struct HybridWebApp: App {
    var body: some Scene {
        WindowGroup {
            HybridWebView()
                .ignoresSafeArea()
        }
    }
}

struct HybridWebView: UIViewRepresentable {
    typealias UIViewType = WKWebView

    func makeUIView(context: Context) -> WKWebView {
        let preferences: WKPreferences = WKPreferences()
        preferences.javaScriptEnabled = true
        preferences.setValue(true, forKey: "developerExtrasEnabled")
        
        let scriptController: WKUserContentController = WKUserContentController()
        scriptController.addUserScript(WKUserScript(source: generateBridge(),
            injectionTime: .atDocumentEnd, forMainFrameOnly: false))

        let config: WKWebViewConfiguration = WKWebViewConfiguration()
        config.preferences = preferences
        config.userContentController = scriptController
        config.setValue(true, forKey: "allowUniversalAccessFromFileURLs")

        let webView = WKWebView(frame: .zero, configuration: config)
        webView.scrollView.contentInsetAdjustmentBehavior = .never
        if #available(iOS 16.4, *) {
            webView.isInspectable = true
        }
        
        let scriptBridge = ScriptBridge(webView: webView)
        scriptController.add(scriptBridge, name: "openNativeBrowser")
        scriptController.add(scriptBridge, name: "loadPreferences")
        scriptController.add(scriptBridge, name: "savePreferences")
        webView.navigationDelegate = scriptBridge
        
        return webView
    }
    
    func updateUIView(_ webView: WKWebView, context: Context) {
        DispatchQueue.main.async {
            let index = "HybridResources/index"
            let path = Bundle.main.path(forResource: index, ofType: "html")!
            let url = URL(fileURLWithPath: path)
            webView.loadFileURL(url, allowingReadAccessTo: url)
        }
    }
    
    func generateBridge() -> String {
        return """
            window.clrz = {
                openNativeBrowser: function(url) {
                    window.webkit.messageHandlers.openNativeBrowser.postMessage({url});
                },
                loadPreferences: function() {
                    window.webkit.messageHandlers.loadPreferences.postMessage({});
                },
                savePreferences: function(name, value) {
                    window.webkit.messageHandlers.savePreferences.postMessage({name, value});
                }
            };
        """
    }
}

class ScriptBridge: NSObject, WKScriptMessageHandler, WKNavigationDelegate {
    var webView: WKWebView
    
    init(webView: WKWebView) {
        self.webView = webView
    }

    func webView(_ webView: WKWebView, decidePolicyFor navigationAction: WKNavigationAction,
                 decisionHandler: @escaping (WKNavigationActionPolicy) -> Void) {
        if let url = navigationAction.request.url {
            if url.absoluteString.starts(with: "https://") {
                UIApplication.shared.open(url)
                decisionHandler(.cancel)
                return
            }
        }

        decisionHandler(.allow)
    }
    
    func userContentController(_ userContentController: WKUserContentController,
                               didReceive message: WKScriptMessage) {
        let body: NSDictionary = message.body as! NSDictionary

        if message.name == "openNativeBrowser" {
            let url: String = body["url"] as! String;
            UIApplication.shared.open(URL(string: url)!)
        } else if message.name == "loadPreferences" {
            loadPreferences(body)
        } else if message.name == "savePreferences" {
            savePreferences(body)
        }
    }

    func loadPreferences(_ body: NSDictionary) {
        for key in UserDefaults.standard.dictionaryRepresentation().keys {
            let value = UserDefaults.standard.string(forKey: key)
            if value != nil {
                webView.evaluateJavaScript("window.localStorage.setItem('\(key)', '\(value!)');");
            }
        }
    }
    
    func savePreferences(_ body: NSDictionary) {
        let name: String = body["name"] as! String;
        let value: String = body["value"] as! String;
        UserDefaults.standard.set(value, forKey: name)
    }
}
